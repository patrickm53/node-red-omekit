os: linux

dist: focal

services: docker

language: shell

env:
    global:
        - QEMU_VERSION=v4.0.0
        - S6_VERSION=v1.22.1.0
        - DOCKER_FILE=Dockerfile.alpine

    jobs:
        ### Node JS 10 #########################################################################################################
        # Default Images
        - NODE_VERSION=10   TAG_SUFFIX=default   QEMU_ARCH=x86_64    ARCH=amd64      S6_ARCH=amd64       FFMPEG_ARCH=x86_64    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=default   QEMU_ARCH=arm       ARCH=arm32v6    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=default   QEMU_ARCH=arm       ARCH=arm32v7    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=default   QEMU_ARCH=aarch64   ARCH=arm64v8    S6_ARCH=aarch64     FFMPEG_ARCH=aarch64   NODE_RED_VERSION=1.3.5
        # Minimal Images
        - NODE_VERSION=10   TAG_SUFFIX=minimal   QEMU_ARCH=x86_64    ARCH=amd64      S6_ARCH=amd64       FFMPEG_ARCH=x86_64    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=minimal   QEMU_ARCH=arm       ARCH=arm32v6    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=minimal   QEMU_ARCH=arm       ARCH=arm32v7    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=1.3.5
        - NODE_VERSION=10   TAG_SUFFIX=minimal   QEMU_ARCH=aarch64   ARCH=arm64v8    S6_ARCH=aarch64     FFMPEG_ARCH=aarch64   NODE_RED_VERSION=1.3.5

        ### Node JS 12 #########################################################################################################
        # Default Images
        - NODE_VERSION=12   TAG_SUFFIX=default   QEMU_ARCH=x86_64    ARCH=amd64      S6_ARCH=amd64       FFMPEG_ARCH=x86_64    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=default   QEMU_ARCH=arm       ARCH=arm32v6    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=default   QEMU_ARCH=arm       ARCH=arm32v7    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=default   QEMU_ARCH=aarch64   ARCH=arm64v8    S6_ARCH=aarch64     FFMPEG_ARCH=aarch64   NODE_RED_VERSION=2.0.1

        # Minimal Images
        - NODE_VERSION=12   TAG_SUFFIX=minimal   QEMU_ARCH=x86_64    ARCH=amd64      S6_ARCH=amd64       FFMPEG_ARCH=x86_64    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=minimal   QEMU_ARCH=arm       ARCH=arm32v6    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=minimal   QEMU_ARCH=arm       ARCH=arm32v7    S6_ARCH=armhf       FFMPEG_ARCH=armv6l    NODE_RED_VERSION=2.0.1
        - NODE_VERSION=12   TAG_SUFFIX=minimal   QEMU_ARCH=aarch64   ARCH=arm64v8    S6_ARCH=aarch64     FFMPEG_ARCH=aarch64   NODE_RED_VERSION=2.0.1

before_install:
    - sudo rm -rf /var/lib/apt/lists/*
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) edge"
    - sudo apt-get update
    - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
    - ./.docker/docker.sh prepare

before_script:
    # Set TARGET Docker Repo
    # default TARGET = nrchkb/node-red-homekit-dev
    # if TRAVIS_TAG starts with a `v` and only contains numbers, dots and/or dash then TARGET = nrchkb/node-red-homekit
    - >
        export TARGET=nrchkb/node-red-homekit-dev

        if [[ "${TRAVIS_TAG}" =~ ^v[0-9\.-]*$ ]]; then
          export TARGET=nrchkb/node-red-homekit
        fi

    # Set NODE_RED_VERSION in package.json
    - >
        sed -ie "s/\"node-red\":[^\"].*\"/\"node-red\": \"${NODE_RED_VERSION}\"/g" package.json

    # Set HOMEKIT_BRIDGED_VERSION from package.json
    - >
        export HOMEKIT_BRIDGED_VERSION=$(grep -oE "\"node-red-contrib-homekit-bridged\": \"(\w*.\w*.\w*.\w*.\w*.)" package.json | cut -d\" -f4)

    # Set BUILD_VERSION
    - >
        if [ ! -z "${TRAVIS_TAG}" ]; then
          export BUILD_VERSION=${TRAVIS_TAG:1};
        fi

script:
    # Build Docker image
    - ./.docker/docker.sh build

    # Test Docker image
    - ./.docker/docker.sh test

    # Push Docker image, only if TRAVIS_TAG is set
    - >
        if [ ! -z "${TRAVIS_TAG}" ]; then
          # Tag Docker image
          ./.docker/docker.sh tag

          # Docker Login
          echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

          # Push Docker image
          ./.docker/docker.sh push

          # Docker Logout
          docker logout
        fi

jobs:
    include:
        - stage: manifest
            # Only create and push manifest list to Docker Hub, when tag starts with a `v`, eg. v1.0.2
          if: tag =~ ^v
          script:
              # Create and push Docker manifest lists
              # The push order is displayed in reverse order on Docker Hub

              # Docker Login
              - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

              # Create and push manifest list `version` for minimal
              - ./.docker/docker.sh manifest-list-version "12" "minimal"
              - ./.docker/docker.sh manifest-list-version "10" "minimal"
              - ./.docker/docker.sh manifest-list-version "" "minimal"

              # Create and push manifest list `version` for default
              - ./.docker/docker.sh manifest-list-version "12" "default"
              - ./.docker/docker.sh manifest-list-version "10" "default"
              - ./.docker/docker.sh manifest-list-version "" "default"

              # Create and push manifest list 'latest' or 'testing' for minimal
              - ./.docker/docker.sh manifest-list-test-beta-latest "12" "minimal"
              - ./.docker/docker.sh manifest-list-test-beta-latest "10" "minimal"
              - ./.docker/docker.sh manifest-list-test-beta-latest "" "minimal"

              # Create and push manifest list 'latest' or 'testing' for default
              - ./.docker/docker.sh manifest-list-test-beta-latest "12" "default"
              - ./.docker/docker.sh manifest-list-test-beta-latest "10" "default"
              - ./.docker/docker.sh manifest-list-test-beta-latest "" "default"

              # Docker Logout
              - docker logout

# Notify me when things fail
notifications:
    email: true
